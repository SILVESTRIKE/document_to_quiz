<%- contentFor('title') %>
    H·ªçc Quiz - Ghi Nh·ªõ C·ªët L√µi

    <%- contentFor('body') %>
        <div
            class="h-[calc(100vh-5rem)] bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 flex flex-col overflow-hidden font-sans text-slate-200 relative">
            <!-- Background Glow -->
            <div class="fixed inset-0 overflow-hidden pointer-events-none">
                <div class="absolute -top-40 -right-40 w-80 h-80 bg-purple-500/10 rounded-full blur-3xl"></div>
                <div class="absolute bottom-0 -left-40 w-60 h-60 bg-indigo-500/10 rounded-full blur-3xl"></div>
            </div>

            <!-- TOP HEADER: T·ªëi gi·∫£n di·ªán t√≠ch -->
            <div class="max-w-4xl mx-auto w-full px-4 pt-3 flex-none">
                <div class="flex items-center justify-between mb-2">
                    <a href="/dashboard"
                        class="text-slate-500 hover:text-white font-black text-xs uppercase tracking-tighter flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path d="M15 19l-7-7 7-7" stroke-width="3"></path>
                        </svg>
                        THO√ÅT
                    </a>

                    <div class="flex items-center gap-3">
                        <div class="flex items-center gap-1">
                            <span class="text-[10px] font-black text-slate-500 uppercase">ƒê√∫ng</span>
                            <div class="bg-emerald-500/20 border border-emerald-500/50 px-3 py-0.5 rounded shadow-[0_0_10px_rgba(16,185,129,0.2)] text-emerald-400 font-black text-sm"
                                id="correctCount">0</div>
                        </div>
                        <div class="flex items-center gap-1">
                            <span class="text-[10px] font-black text-slate-500 uppercase">Sai</span>
                            <div class="bg-rose-500/20 border border-rose-500/50 px-3 py-0.5 rounded shadow-[0_0_10px_rgba(244,63,94,0.2)] text-rose-400 font-black text-sm"
                                id="wrongCount">0</div>
                        </div>
                    </div>
                </div>

                <!-- Thanh ti·∫øn tr√¨nh m·∫£nh -->
                <div class="h-1.5 bg-white/5 rounded-full overflow-hidden border border-white/5">
                    <div id="progressBar"
                        class="h-full bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 transition-all duration-700 shadow-[0_0_15px_rgba(168,85,247,0.4)]"
                        style="width: 0%"></div>
                </div>
            </div>

            <!-- MAIN AREA: Chi·∫øm to√†n b·ªô kh√¥ng gian c√≤n l·∫°i -->
            <div class="max-w-4xl mx-auto w-full pb-4 flex-1 flex flex-col min-h-0 mt-2">

                <!-- Section Info Badge -->
                <div id="sectionInfo"
                    class="hidden text-center mb-2 px-4 py-2 bg-purple-500/20 border border-purple-500/30 rounded-lg text-purple-300 font-semibold">
                </div>

                <div id="flashcardContainer" class="flex-1 flex flex-col min-h-0">

                    <!-- Loading State -->
                    <div id="loadingState" class="flex flex-col items-center justify-center h-full">
                        <div
                            class="animate-spin rounded-full h-12 w-12 border-4 border-purple-500 border-t-transparent mb-4">
                        </div>
                        <p class="font-black text-slate-400 uppercase tracking-widest text-xs">ƒêang t·∫£i ki·∫øn th·ª©c...</p>
                    </div>

                    <!-- Question Card -->
                    <div id="questionCard" class="hidden h-full flex flex-col min-h-0">

                        <!-- V√πng n·ªôi dung c√≥ th·ªÉ cu·ªôn n·ªôi b·ªô -->
                        <div class="flex-1 overflow-y-auto pr-2 custom-scroll">
                            <div class="mb-4">
                                <span
                                    class="bg-slate-800 text-slate-400 px-2 py-0.5 rounded text-[10px] font-black uppercase tracking-widest border border-slate-700">C√ÇU
                                    <span id="questionNumber">1</span></span>
                                <h2 id="questionText"
                                    class="text-xl md:text-2xl text-white font-black leading-tight mt-2 italic tracking-tight">
                                </h2>
                            </div>

                            <!-- Choices Grid: 2 c·ªôt tr√™n PC -->
                            <div id="choicesContainer"
                                class="grid grid-cols-1 md:grid-cols-2 gap-3 transition-all duration-500 mx-5">
                                <!-- JS s·∫Ω render ƒë√°p √°n ·ªü ƒë√¢y -->
                            </div>

                            <!-- Ghi nh·ªõ c·ªët l√µi: Dark Theme -->
                            <div id="explanationBox" class="hidden mt-4 transform animate-in zoom-in duration-300">
                                <div
                                    class="bg-slate-800/80 backdrop-blur-xl rounded-2xl p-5 shadow-2xl border border-white/10">
                                    <div class="flex items-center mb-4">
                                        <div class="bg-gradient-to-r from-purple-500 to-indigo-500 p-2 rounded-lg mr-3">
                                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                                <path
                                                    d="M11 3a1 1 0 10-2 0v1a1 1 0 102 0V3zM15.657 5.757a1 1 0 00-1.414-1.414l-.707.707a1 1 0 001.414 1.414l.707-.707zM18 10a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zM5.05 6.464A1 1 0 106.464 5.05l-.707-.707a1 1 0 00-1.414 1.414l.707.707zM5 10a1 1 0 01-1 1H3a1 1 0 110-2h1a1 1 0 011 1zM8 16v-1a1 1 0 112 0v1a1 1 0 11-2 0zM13.536 14.95a1 1 0 011.414 0l.707.707a1 1 0 01-1.414 1.414l-.707-.707a1 1 0 010-1.414zM6.464 14.95l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414z">
                                                </path>
                                            </svg>
                                        </div>
                                        <h3 class="text-white font-black uppercase tracking-tight text-base">Ghi nh·ªõ c·ªët
                                            l√µi</h3>
                                    </div>

                                    <!-- C√¢u tr·∫£ l·ªùi ƒë√∫ng -->
                                    <div class="bg-emerald-500/20 border-l-4 border-emerald-400 p-4 rounded-r-xl mb-4">
                                        <p class="text-emerald-400 text-[10px] font-black uppercase mb-1">C√¢u tr·∫£ l·ªùi
                                            ƒë√∫ng:</p>
                                        <p id="repeatAnswer" class="text-white font-bold text-lg leading-tight"></p>
                                    </div>

                                    <p id="explanationText" class="text-slate-300 font-medium text-sm leading-relaxed">
                                    </p>

                                    <div
                                        class="mt-4 pt-3 border-t border-white/10 flex justify-between items-center text-[9px] font-bold text-slate-500 uppercase tracking-widest">
                                        <span>AI Powered</span>
                                        <span class="text-emerald-400 flex items-center gap-1">
                                            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd"
                                                    d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                                    clip-rule="evenodd"></path>
                                            </svg>
                                            Verified
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- N√∫t Ti·∫øp t·ª•c c·ªë ƒë·ªãnh ·ªü ƒë√°y -->
                        <div class="py-3 flex-none">
                            <button id="nextButton" onclick="nextQuestion()"
                                class="hidden w-full py-4 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-500 hover:to-indigo-500 text-white font-black rounded-2xl transition-all shadow-[0_10px_30px_-10px_rgba(147,51,234,0.5)] active:scale-95 uppercase tracking-[0.15em] text-lg">
                                TI·∫æP T·ª§C H·ªåC ‚Üí
                            </button>
                            <p id="hintText"
                                class="text-center font-bold text-slate-600 uppercase text-[9px] tracking-[0.3em] animate-pulse">
                                Ch·ªçn ph∆∞∆°ng √°n (Ph√≠m A/B/C/D) ‚Ä¢ Ti·∫øp t·ª•c (Enter)</p>
                        </div>
                    </div>
                </div>

                <!-- Results Panel -->
                <div id="resultsPanel" class="hidden h-full flex items-center justify-center">
                    <div
                        class="bg-slate-900 rounded-[2.5rem] p-8 border-2 border-slate-800 text-center w-full max-w-md shadow-2xl">
                        <div class="text-5xl mb-4">‚ú®</div>
                        <h2 class="text-2xl font-black text-white mb-2 uppercase tracking-tighter">Ho√†n th√†nh b√†i h·ªçc
                        </h2>
                        <div class="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500 mb-6"
                            id="finalScore">0%</div>

                        <div class="flex flex-col gap-3">
                            <button onclick="retryQuiz()"
                                class="py-4 bg-white text-black font-black rounded-2xl text-lg uppercase transition-all hover:bg-yellow-400">L√†m
                                l·∫°i</button>
                            <a href="/dashboard"
                                class="py-4 bg-slate-800 text-white font-black rounded-2xl text-lg uppercase">Dashboard</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <style>
            /* M√†u s·∫Øc ƒë·∫∑c tr∆∞ng cho A, B, C, D */
            .btn-A {
                --c: #3b82f6;
                --g: rgba(59, 130, 246, 0.4);
            }

            .btn-B {
                --c: #a855f7;
                --g: rgba(168, 85, 247, 0.4);
            }

            .btn-C {
                --c: #ec4899;
                --g: rgba(236, 72, 153, 0.4);
            }

            .btn-D {
                --c: #f59e0b;
                --g: rgba(245, 158, 11, 0.4);
            }

            .choice-btn {
                background: #0f172a;
                border: 2px solid #1e293b;
                transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
                position: relative;
            }

            .choice-btn:hover:not(.choices-active .choice-btn) {
                transform: translateY(-2px);
                border-color: var(--c);
                box-shadow: 0 4px 12px var(--g);
            }

            .choice-btn .key-tag {
                background: var(--c);
                color: white;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
                transition: all 0.3s ease;
            }

            /* Khi ƒë√£ tr·∫£ l·ªùi - c√°c c√¢u sai m·ªù ƒëi m∆∞·ª£t m√† */
            .choices-active .choice-btn:not(.is-correct):not(.is-wrong-selection) {
                opacity: 0.2;
                transform: scale(0.95);
                filter: grayscale(1) blur(1px);
                pointer-events: none;
                transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            }

            /* ƒê√°p √°n ƒë√∫ng - n·ªïi b·∫≠t v·ªõi hi·ªáu ·ª©ng pulse */
            .choice-btn.is-correct {
                border-color: #10b981 !important;
                transform: scale(1.03);
                box-shadow: 0 0 20px rgba(16, 185, 129, 0.5), 0 0 40px rgba(16, 185, 129, 0.3);
                z-index: 20;
                opacity: 1 !important;
                animation: correctPulse 1.5s ease-in-out infinite;
            }

            .choice-btn.is-correct .key-tag {
                background: #10b981 !important;
            }

            @keyframes correctPulse {

                0%,
                100% {
                    box-shadow: 0 0 20px rgba(16, 185, 129, 0.5), 0 0 40px rgba(16, 185, 129, 0.3);
                }

                50% {
                    box-shadow: 0 0 30px rgba(16, 185, 129, 0.7), 0 0 60px rgba(16, 185, 129, 0.4);
                }
            }

            /* ƒê√°p √°n sai ƒë∆∞·ª£c ch·ªçn - shake m∆∞·ª£t + highlight ƒë·ªè */
            .choice-btn.is-wrong-selection {
                border-color: #ef4444 !important;
                background: rgba(239, 68, 68, 0.1) !important;
                opacity: 1 !important;
                filter: none !important;
                animation: wrongShake 0.6s ease;
            }

            .choice-btn.is-wrong-selection .key-tag {
                background: #ef4444 !important;
            }

            @keyframes wrongShake {

                0%,
                100% {
                    transform: translateX(0);
                }

                10%,
                30%,
                50%,
                70%,
                90% {
                    transform: translateX(-4px);
                }

                20%,
                40%,
                60%,
                80% {
                    transform: translateX(4px);
                }
            }

            /* Explanation box animation */
            #explanationBox {
                animation: slideUp 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            }

            @keyframes slideUp {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }

                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .custom-scroll::-webkit-scrollbar {
                width: 4px;
            }

            .custom-scroll::-webkit-scrollbar-thumb {
                background: #1e293b;
                border-radius: 10px;
            }
        </style>

        <script>
            let quizData = null;
            let currentQuestionIndex = 0;
            let correctCount = 0;
            let wrongCount = 0;
            let answered = false;
            const quizId = '<%= quizId %>';

            // Fisher-Yates shuffle algorithm
            function shuffleArray(array) {
                const shuffled = [...array];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled;
            }

            async function loadQuiz() {
                try {
                    const response = await window.authManager.fetchWithAuth(`/api/v1/quizzes/${quizId}`);
                    if (!response.ok) throw new Error('Fail');
                    quizData = await response.json();

                    // Check if section filter is specified in URL
                    const urlParams = new URLSearchParams(window.location.search);
                    const sectionFilter = urlParams.get('section');

                    if (sectionFilter) {
                        // Normalize: remove all spaces and uppercase for comparison
                        const normalizedFilter = sectionFilter.replace(/\s+/g, '').toUpperCase();
                        console.log('[Practice] Normalized filter (no spaces):', normalizedFilter);

                        quizData.questions = quizData.questions.filter(function (q) {
                            // Remove spaces from section too before comparing
                            const normalizedSection = (q.section || '').replace(/\s+/g, '').toUpperCase();
                            return normalizedSection === normalizedFilter;
                        });

                        console.log('[Practice] Filtered count:', quizData.questions.length);

                        // Show section name in title
                        document.getElementById('sectionInfo').textContent = `üìö ${sectionFilter} (${quizData.questions.length} c√¢u)`;
                        document.getElementById('sectionInfo').classList.remove('hidden');
                    }

                    // Shuffle questions for random order each time
                    quizData.questions = shuffleArray(quizData.questions);

                    document.getElementById('loadingState').classList.add('hidden');
                    document.getElementById('questionCard').classList.remove('hidden');
                    showQuestion(0);
                } catch (e) {
                    document.getElementById('loadingState').innerHTML = `<p class="text-rose-500 font-black">L·ªñI T·∫¢I D·ªÆ LI·ªÜU</p>`;
                }
            }

            function showQuestion(index) {
                const question = quizData.questions[index];
                answered = false;

                document.getElementById('questionNumber').textContent = index + 1;
                document.getElementById('questionText').textContent = question.stem;
                document.getElementById('explanationBox').classList.add('hidden');
                document.getElementById('nextButton').classList.add('hidden');
                document.getElementById('hintText').classList.remove('hidden');

                const container = document.getElementById('choicesContainer');
                container.classList.remove('choices-active');

                container.innerHTML = question.choices.map(choice => `
                <button onclick="selectAnswer('${choice.key}')" 
                        id="btn-${choice.key}"
                        class="choice-btn btn-${choice.key} flex items-center p-3.5 rounded-2xl text-left">
                    <span class="key-tag w-9 h-9 flex-none flex items-center justify-center rounded-xl text-lg font-black mr-3 uppercase">
                        ${choice.key}
                    </span>
                    <span class="text-white font-bold text-base leading-tight">${escapeHtml(choice.text)}</span>
                </button>
            `).join('');

                updateProgress();
                // Cu·ªôn n·ªôi dung l√™n ƒë·∫ßu
                document.querySelector('.custom-scroll').scrollTop = 0;
            }

            function selectAnswer(choiceKey) {
                if (answered) return;
                answered = true;

                const question = quizData.questions[currentQuestionIndex];
                const correctKey = question.correctAnswerKey;
                const isCorrect = choiceKey === correctKey;

                if (isCorrect) correctCount++; else wrongCount++;
                document.getElementById('correctCount').textContent = correctCount;
                document.getElementById('wrongCount').textContent = wrongCount;

                // Hi·ªáu ·ª©ng Visual
                document.getElementById('choicesContainer').classList.add('choices-active');
                document.getElementById(`btn-${correctKey}`).classList.add('is-correct');
                if (!isCorrect) document.getElementById(`btn-${choiceKey}`).classList.add('is-wrong-selection');

                // Ghim ki·∫øn th·ª©c v√†o box xanh
                const correctChoiceObj = question.choices.find(c => c.key === correctKey);
                document.getElementById('repeatAnswer').textContent = `${correctKey}. ${correctChoiceObj.text}`;

                // N·∫øu tr·∫£ l·ªùi sai -> G·ªçi AI gi·∫£i th√≠ch
                if (!isCorrect) {
                    document.getElementById('explanationText').innerHTML = '<span class="animate-pulse">AI ƒëang ph√¢n t√≠ch...</span>';
                    document.getElementById('explanationBox').classList.remove('hidden');

                    // G·ªçi API gi·∫£i th√≠ch (d√πng fetch th∆∞·ªùng v√¨ endpoint c√≥ th·ªÉ public)
                    fetch(`/api/v1/quizzes/${quizId}/questions/${question.id}/explain`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ userAnswerKey: choiceKey })
                    })
                        .then(res => res.json())
                        .then(data => {
                            if (data.explanation) {
                                document.getElementById('explanationText').textContent = data.explanation;
                            } else if (data.error) {
                                document.getElementById('explanationText').textContent = "ƒêƒÉng nh·∫≠p ƒë·ªÉ xem gi·∫£i th√≠ch chi ti·∫øt t·ª´ AI.";
                            }
                        })
                        .catch(err => {
                            console.error('[Practice] Explain error:', err);
                            document.getElementById('explanationText').textContent = "H√£y ghi nh·ªõ ƒë√°p √°n ƒë√∫ng n√†y.";
                        });
                } else {
                    // ƒê√∫ng -> hi·ªán message
                    document.getElementById('explanationText').textContent = "Tuy·ªát v·ªùi! B·∫°n ƒë√£ n·∫Øm v·ªØng ki·∫øn th·ª©c n√†y.";
                    document.getElementById('explanationBox').classList.remove('hidden');
                }

                document.getElementById('nextButton').classList.remove('hidden');
                document.getElementById('hintText').classList.add('hidden');

                // T·ª± ƒë·ªông cu·ªôn nh·∫π ƒë·∫øn ph·∫ßn gi·∫£i th√≠ch
                setTimeout(() => {
                    document.getElementById('explanationBox').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 100);

                if (currentQuestionIndex >= quizData.questions.length - 1) {
                    document.getElementById('nextButton').textContent = 'XEM K·∫æT QU·∫¢ CU·ªêI';
                }
            }

            function nextQuestion() {
                currentQuestionIndex++;
                if (currentQuestionIndex >= quizData.questions.length) showResults();
                else showQuestion(currentQuestionIndex);
            }

            function updateProgress() {
                const percent = Math.round((currentQuestionIndex / quizData.questions.length) * 100);
                document.getElementById('progressBar').style.width = `${percent}%`;
            }

            function showResults() {
                document.getElementById('flashcardContainer').classList.add('hidden');
                document.getElementById('resultsPanel').classList.remove('hidden');
                const percent = Math.round((correctCount / quizData.questions.length) * 100);
                document.getElementById('finalScore').textContent = `${percent}%`;
            }

            function retryQuiz() { location.reload(); }
            function escapeHtml(t) { const d = document.createElement('div'); d.textContent = t || ''; return d.innerHTML; }

            document.addEventListener('DOMContentLoaded', loadQuiz);

            // Keyboard shortcuts: A, B, C, D (or 1, 2, 3, 4) ƒë·ªÉ ch·ªçn ƒë√°p √°n, Enter/Space ƒë·ªÉ ti·∫øp t·ª•c
            document.addEventListener('keydown', function (e) {
                // Ignore if user is typing in an input field
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

                const key = e.key.toUpperCase();

                // Map ph√≠m s·ªë sang ch·ªØ c√°i
                const keyMap = { '1': 'A', '2': 'B', '3': 'C', '4': 'D' };
                const mappedKey = keyMap[key] || key;

                // Ch·ªçn ƒë√°p √°n b·∫±ng ph√≠m A, B, C, D ho·∫∑c 1, 2, 3, 4
                if (['A', 'B', 'C', 'D'].includes(mappedKey)) {
                    if (!answered && quizData && document.getElementById(`btn-${mappedKey}`)) {
                        selectAnswer(mappedKey);
                    }
                }

                // Nh·∫•n Enter ho·∫∑c Space ƒë·ªÉ ti·∫øp t·ª•c
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault(); // Prevent page scroll on Space
                    const nextBtn = document.getElementById('nextButton');
                    if (nextBtn && !nextBtn.classList.contains('hidden')) {
                        nextQuestion();
                    }
                }
            });
        </script>